/*! coi-serviceworker FINAL - ServiceWorker only version */
/* This file MUST be registered via navigator.serviceWorker.register() */

self.addEventListener('install', () => {
  self.skipWaiting();
});

self.addEventListener('activate', event => {
  event.waitUntil(self.clients.claim());
});

self.addEventListener('message', event => {
  if (event.data && event.data.type === 'coi-cs') {
    if (typeof SharedArrayBuffer === 'undefined') {
      console.error(
        'COI: SharedArrayBuffer is not available. Cross-origin isolation NOT active.'
      );
    } else {
      console.log(
        'COI: SharedArrayBuffer available. Cross-origin isolation active.'
      );
    }
  }
});

self.addEventListener('fetch', event => {
  const request = event.request;

  // Skip unsupported requests (Chrome quirk)
  if (
    request.cache === 'only-if-cached' &&
    request.mode !== 'same-origin'
  ) {
    return;
  }

  const destination = request.destination;

  // Handle HTML documents
  if (destination === 'document') {
    event.respondWith(
      fetch(request).then(response => {
        // Cannot modify opaque responses
        if (response.type === 'opaque') return response;

        const headers = new Headers(response.headers);
        headers.set('Cross-Origin-Opener-Policy', 'same-origin');
        headers.set('Cross-Origin-Embedder-Policy', 'require-corp');

        return new Response(response.body, {
          status: response.status,
          statusText: response.statusText,
          headers
        });
      })
    );
    return;
  }

  // Handle JS / Worker / WASM
  if (
    destination === 'script' ||
    destination === 'worker' ||
    destination === 'wasm'
  ) {
    event.respondWith(
      fetch(request).then(response => {
        if (response.type === 'opaque') return response;

        const headers = new Headers(response.headers);
        headers.set('Cross-Origin-Embedder-Policy', 'require-corp');

        return new Response(response.body, {
          status: response.status,
          statusText: response.statusText,
          headers
        });
      })
    );
    return;
  }
});
