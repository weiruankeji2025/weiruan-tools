<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ è½¬ GIF å·¥å…·</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>

    <nav class="navbar">
    <a href="index.html" class="nav-link">ğŸ–¼ï¸ å›¾ç‰‡è½¬æ¢</a>
    <a href="video.html" class="nav-link active">ğŸ¬ è§†é¢‘è½¬GIF</a>
</nav>
    <h1>ğŸ¬ è§†é¢‘è½¬ GIF å·¥å…·</h1>

    <div class="container">
        <p>å°† MP4 è§†é¢‘è½¬æ¢ä¸º GIF åŠ¨å›¾ã€‚å¤„ç†åœ¨æœ¬åœ°è¿›è¡Œï¼Œä¿æŠ¤éšç§ã€‚</p>

        <input type="file" id="uploader" accept="video/mp4, video/webm">
        
        <br>
        
        <button id="convertBtn" class="btn" disabled>æ­£åœ¨åŠ è½½æ ¸å¿ƒ...</button>
        
        <p id="message">æ­£åœ¨åˆå§‹åŒ– FFmpeg å¼•æ“ï¼Œè¯·ç¨å€™...</p>
        
        <img id="outputImage" style="display:none; border: 2px solid #eee;">
    </div>

    <script>
  // ä» UMD å…¨å±€å¯¹è±¡é‡Œæ‹¿åˆ° createFFmpeg å’Œ fetchFile
  const { createFFmpeg, fetchFile } = FFmpeg;

  const uploader = document.getElementById('uploader');
  const convertBtn = document.getElementById('convertBtn');
  const message = document.getElementById('message');
  const outputImage = document.getElementById('outputImage');

  // åˆ›å»º ffmpeg å®ä¾‹
  const ffmpeg = createFFmpeg({ log: true });

  let selectedFile = null;

  // 1ï¼‰é¡µé¢åŠ è½½åå…ˆåˆå§‹åŒ– FFmpeg
  (async () => {
    try {
      message.textContent = 'æ­£åœ¨åˆå§‹åŒ– FFmpeg å¼•æ“ï¼Œè¯·ç¨å€™...';

      await ffmpeg.load(); // è¿™é‡Œä¼šæ¯”è¾ƒæ…¢ï¼Œå°¤å…¶ç¬¬ä¸€æ¬¡ï¼Œå±äºæ­£å¸¸

      message.textContent = 'FFmpeg å·²å°±ç»ªï¼Œè¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚';
      convertBtn.disabled = false;
      convertBtn.textContent = 'å¼€å§‹è½¬æ¢ä¸º GIF';
    } catch (err) {
      console.error(err);
      message.textContent = 'FFmpeg åˆå§‹åŒ–å¤±è´¥ï¼š' + err.message;
    }
  })();

  // 2ï¼‰ç›‘å¬ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶
  uploader.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
      selectedFile = null;
      return;
    }
    selectedFile = file;
    message.textContent = 'å·²é€‰æ‹©æ–‡ä»¶ï¼š' + file.name + 'ï¼Œç‚¹å‡»â€œå¼€å§‹è½¬æ¢ä¸º GIFâ€ã€‚';
  });

  // 3ï¼‰ç‚¹å‡»â€œè½¬æ¢â€ä¸º GIF
  convertBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ï¼');
      return;
    }

    convertBtn.disabled = true;
    convertBtn.textContent = 'æ­£åœ¨è½¬æ¢...';
    message.textContent = 'æ­£åœ¨è½¬æ¢ä¸º GIFï¼Œè¯·ç¨å€™...';

    try {
      // æŠŠè§†é¢‘å†™å…¥ FFmpeg è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
      const inputName = 'input.' + (selectedFile.name.split('.').pop() || 'mp4');
      const outputName = 'output.gif';

      ffmpeg.FS('writeFile', inputName, await fetchFile(selectedFile));

      // è¿™é‡Œå¯ä»¥è°ƒæ•´å‚æ•°ï¼Œæ¯”å¦‚æ—¶é•¿ã€å¸§ç‡ã€å¤§å°ç­‰ç­‰
      await ffmpeg.run(
        '-i', inputName,
        '-vf', 'fps=10,scale=320:-1:flags=lanczos',
        '-t', '5',
        outputName
      );

      // ä»è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¯»å‡º gif
      const data = ffmpeg.FS('readFile', outputName);
      const blob = new Blob([data.buffer], { type: 'image/gif' });
      const url = URL.createObjectURL(blob);

      // æ˜¾ç¤ºç»“æœ GIF
      outputImage.src = url;
      outputImage.style.display = 'block';

      message.textContent = 'è½¬æ¢å®Œæˆ âœ… ï¼ˆå³é”®å›¾ç‰‡å¯â€œå›¾ç‰‡å¦å­˜ä¸ºâ€ï¼‰';
    } catch (err) {
      console.error(err);
      message.textContent = 'è½¬æ¢å¤±è´¥ï¼š' + err.message;
    } finally {
      convertBtn.disabled = false;
      convertBtn.textContent = 'å¼€å§‹è½¬æ¢ä¸º GIF';
    }
  });
</script>

</body>

</html>







