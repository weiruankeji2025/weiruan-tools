<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ è½¬ GIF å·¥å…·</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>

    <h1>ğŸ¬ è§†é¢‘è½¬ GIF å·¥å…·</h1>

    <div class="container">
        <p>å°† MP4 è§†é¢‘è½¬æ¢ä¸º GIF åŠ¨å›¾ã€‚å¤„ç†åœ¨æœ¬åœ°è¿›è¡Œï¼Œä¿æŠ¤éšç§ã€‚</p>

        <input type="file" id="uploader" accept="video/mp4, video/webm">
        
        <br>
        
        <button id="convertBtn" class="btn" disabled>æ­£åœ¨åŠ è½½æ ¸å¿ƒ...</button>
        
        <p id="message">æ­£åœ¨åˆå§‹åŒ– FFmpeg å¼•æ“ï¼Œè¯·ç¨å€™...</p>
        
        <img id="outputImage" style="display:none; border: 2px solid #eee;">
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // åˆ›å»º ffmpeg å®ä¾‹
        const ffmpeg = createFFmpeg({ log: true });

        const init = async () => {
            try {
                await ffmpeg.load();
                document.getElementById('message').innerText = 'æ ¸å¿ƒåŠ è½½å®Œæ¯•ï¼Œè¯·é€‰æ‹©è§†é¢‘å¹¶ç‚¹å‡»è½¬æ¢ã€‚';
                const btn = document.getElementById('convertBtn');
                btn.innerText = 'å¼€å§‹è½¬æ¢';
                btn.disabled = false; // å¯ç”¨æŒ‰é’®
            } catch (error) {
                console.error(error);
                document.getElementById('message').innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ SharedArrayBuffer (éœ€è¦ https ç¯å¢ƒæˆ– localhost)ã€‚';
            }
        };

        const convert = async () => {
            const files = document.getElementById('uploader').files;
            const msg = document.getElementById('message');
            const outputImg = document.getElementById('outputImage');

            if (files.length === 0) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ï¼");
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            document.getElementById('convertBtn').disabled = true;
            document.getElementById('convertBtn').innerText = 'è½¬æ¢ä¸­...';
            msg.innerText = 'æ­£åœ¨å¤„ç†è§†é¢‘å¸§ï¼Œè¯·å‹¿å…³é—­é¡µé¢...';
            
            outputImg.style.display = 'none'; // éšè—æ—§å›¾ç‰‡

            const file = files[0];
            const fileName = 'input.mp4';

            try {
                // 1. å°†æ–‡ä»¶å†™å…¥ FFmpeg å†…å­˜æ–‡ä»¶ç³»ç»Ÿ
                ffmpeg.FS('writeFile', fileName, await fetchFile(file));

                // 2. è¿è¡Œè½¬æ¢å‘½ä»¤
                // å‚æ•°è§£é‡Šï¼š
                // -i: è¾“å…¥æ–‡ä»¶
                // -t 5: åªæˆªå–å‰5ç§’ (é˜²æ­¢è¿‡å¤§ï¼Œä½ å¯ä»¥å»æ‰è¿™ä¸ªå‚æ•°è½¬æ¢å…¨é•¿)
                // -vf fps=10,scale=320:-1 : å¸§ç‡è®¾ä¸º10ï¼Œå®½åº¦ç¼©æ”¾åˆ°320(é«˜åº¦è‡ªé€‚åº”)ï¼Œå‡å°ä½“ç§¯
                await ffmpeg.run('-i', fileName, '-t', '5', '-vf', 'fps=10,scale=320:-1', '-f', 'gif', 'output.gif');

                // 3. è¯»å–ç”Ÿæˆçš„æ–‡ä»¶
                const data = ffmpeg.FS('readFile', 'output.gif');

                // 4. åˆ›å»º URL å¹¶æ˜¾ç¤º
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'image/gif' }));
                outputImg.src = url;
                outputImg.style.display = 'block';
                
                msg.innerText = 'è½¬æ¢æˆåŠŸï¼ğŸ‘‡ä¸‹æ–¹å›¾ç‰‡å¯å³é”®ä¿å­˜ã€‚';
            } catch (e) {
                console.error(e);
                msg.innerText = 'è½¬æ¢å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('convertBtn').disabled = false;
                document.getElementById('convertBtn').innerText = 'å†æ¬¡è½¬æ¢';
            }
        }

        document.getElementById('convertBtn').addEventListener('click', convert);
        
        init();
    </script>
</body>
</html>